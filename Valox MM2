-- Valox MM2 ESP + Kill All v1
if getgenv().ValoxMM2ESP then
    getgenv().ValoxMM2ESP:Destroy()
end

local ValoxESP = {}
getgenv().ValoxMM2ESP = ValoxESP

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ValoxMM2ESP"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game:GetService("CoreGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0,250,0,230)
MainFrame.Position = UDim2.new(0.05,0,0.2,0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
MainFrame.BackgroundTransparency = 0.3
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0,12)
corner.Parent = MainFrame

MainFrame.Active = true
MainFrame.Draggable = true

-- Show button (reopen GUI)
local ShowButton = Instance.new("TextButton")
ShowButton.Size = UDim2.new(0,40,0,40)
ShowButton.Position = UDim2.new(0.05,0,0.2,0)
ShowButton.Text = "O"
ShowButton.TextScaled = true
ShowButton.BackgroundColor3 = Color3.fromRGB(100,100,100)
ShowButton.TextColor3 = Color3.new(1,1,1)
ShowButton.Visible = false
ShowButton.Parent = ScreenGui

local showCorner = Instance.new("UICorner")
showCorner.CornerRadius = UDim.new(0,20)
showCorner.Parent = ShowButton

ShowButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = true
    ShowButton.Visible = false
end)

-- Close GUI circle button
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0,30,0,30)
CloseButton.Position = UDim2.new(1,-35,0,5)
CloseButton.Text = "X"
CloseButton.BackgroundColor3 = Color3.fromRGB(200,200,200)
CloseButton.TextColor3 = Color3.new(0,0,0)
CloseButton.Parent = MainFrame
local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0,15)
closeCorner.Parent = CloseButton

CloseButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = false
    ShowButton.Visible = true
end)

-- Toggle Helper
local function CreateToggle(name, default)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,0,30)
    frame.BackgroundTransparency = 1
    frame.Parent = MainFrame

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.65,0,1,0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = Color3.new(1,1,1)
    label.TextScaled = true
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0.35,0,1,0)
    button.Position = UDim2.new(0.65,0,0,0)
    button.Text = default and "ON" or "OFF"
    button.TextScaled = true
    button.BackgroundColor3 = default and Color3.fromRGB(0,150,0) or Color3.fromRGB(150,0,0)
    button.TextColor3 = Color3.new(1,1,1)
    button.Parent = frame

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0,12)
    corner.Parent = button

    local state = default
    button.MouseButton1Click:Connect(function()
        state = not state
        button.Text = state and "ON" or "OFF"
        local tween = TweenService:Create(button,TweenInfo.new(0.2),{BackgroundColor3 = state and Color3.fromRGB(0,150,0) or Color3.fromRGB(150,0,0)})
        tween:Play()
    end)

    return function() return state end
end

local ShowESP = CreateToggle("ESP", true)
local ShowNames = CreateToggle("Name ESP", true)

-- Kill All Button
local KillButton = Instance.new("TextButton")
KillButton.Size = UDim2.new(1, -10, 0, 40)
KillButton.Position = UDim2.new(0,5,0,130)
KillButton.Text = "Kill All"
KillButton.BackgroundColor3 = Color3.fromRGB(200,0,0)
KillButton.TextColor3 = Color3.new(1,1,1)
KillButton.TextScaled = true
KillButton.Parent = MainFrame

local killCorner = Instance.new("UICorner")
killCorner.CornerRadius = UDim.new(0,12)
killCorner.Parent = KillButton

KillButton.MouseButton1Click:Connect(function()
    local char = LocalPlayer.Character
    if not char then return end
    local knife = char:FindFirstChild("Knife")
    if not knife then return end
    knife.Parent = LocalPlayer.Backpack
    knife.Parent = char -- equip
    local start = tick()
    while tick() - start < 3 do
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = char.HumanoidRootPart.CFrame + char.HumanoidRootPart.CFrame.LookVector * 5
                pcall(function()
                    knife.Stab:FireServer("Slash")
                end)
            end
        end
        task.wait(0.1)
    end
end)

-- Role detection
local function getRoleColor(player)
    local char = player.Character
    if char then
        local hasKnife = char:FindFirstChild("Knife") or (player:FindFirstChild("Backpack") and player.Backpack:FindFirstChild("Knife"))
        local hasGun = char:FindFirstChild("Gun") or (player:FindFirstChild("Backpack") and player.Backpack:FindFirstChild("Gun"))
        if hasKnife then return Color3.fromRGB(255,0,0) -- Murderer
        elseif hasGun then return Color3.fromRGB(0,0,255) -- Sheriff
        else return Color3.fromRGB(0,255,0) end -- Innocent
    end
    return Color3.fromRGB(255,255,255)
end

-- ESP Handler
ValoxESP.Boxes = {}
ValoxESP.Names = {}

local function createESP(player)
    if ValoxESP.Boxes[player] then return end
    if not player.Character then return end
    local highlight = Instance.new("Highlight")
    highlight.Name = "ValoxESPHighlight"
    highlight.Adornee = player.Character
    highlight.FillColor = getRoleColor(player)
    highlight.FillTransparency = 0.25
    highlight.OutlineColor = Color3.new(1,1,1)
    highlight.OutlineTransparency = 0
    highlight.Parent = player.Character
    ValoxESP.Boxes[player] = highlight

    local head = player.Character:FindFirstChild("Head")
    if not head then return end
    local nameTag = Instance.new("BillboardGui")
    nameTag.Name = "ValoxESPName"
    nameTag.Adornee = head
    nameTag.Size = UDim2.new(0,100,0,30)
    nameTag.AlwaysOnTop = true

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    label.Text = player.Name
    label.TextColor3 = getRoleColor(player)
    label.Parent = nameTag
    nameTag.Parent = player.Character
    ValoxESP.Names[player] = label
end

local function removeESP(player)
    if ValoxESP.Boxes[player] then
        ValoxESP.Boxes[player]:Destroy()
        ValoxESP.Boxes[player] = nil
    end
    if ValoxESP.Names[player] then
        ValoxESP.Names[player].Parent:Destroy()
        ValoxESP.Names[player] = nil
    end
end

local function updateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if ShowESP() then
                createESP(player)
                if ValoxESP.Boxes[player] then
                    ValoxESP.Boxes[player].FillColor = getRoleColor(player)
                end
            else
                removeESP(player)
            end
            if ShowNames() and ValoxESP.Names[player] then
                ValoxESP.Names[player].TextColor3 = getRoleColor(player)
            end
        end
    end
    -- Hide GUI if all ESP toggles are off
    if not ShowESP() and not ShowNames() then
        MainFrame.Visible = false
        ShowButton.Visible = true
    end
end

-- Connect events
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        task.wait(0.5)
        updateESP()
    end)
end)

Players.PlayerRemoving:Connect(function(player)
    removeESP(player)
end)

RunService.Heartbeat:Connect(function()
    updateESP()
end)