-- Valox MM2 ESP + KillAll + GunBeam
if getgenv().ValoxMM2ESP then
    getgenv().ValoxMM2ESP:Destroy()
end

local ValoxESP = {}
getgenv().ValoxMM2ESP = ValoxESP

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Cleanup previous ESP
ValoxESP.Boxes = {}
ValoxESP.Names = {}
ValoxESP.Connections = {}
ValoxESP.Settings = {
    ESPEnabled = true
}

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ValoxMM2ESP"
ScreenGui.Parent = game:GetService("CoreGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0,250,0,220)
MainFrame.Position = UDim2.new(0.05,0,0.2,0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
MainFrame.BackgroundTransparency = 0.3
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui
MainFrame.ClipsDescendants = true

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0,12)
corner.Parent = MainFrame

-- Draggable
MainFrame.Active = true
MainFrame.Draggable = true

-- Show button (when GUI hidden)
local ShowButton = Instance.new("TextButton")
ShowButton.Size = UDim2.new(0,50,0,50)
ShowButton.Position = UDim2.new(0,10,0,10)
ShowButton.Text = "ESP"
ShowButton.Visible = false
ShowButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
ShowButton.TextColor3 = Color3.new(1,1,1)
local showCorner = Instance.new("UICorner")
showCorner.CornerRadius = UDim.new(0,25)
showCorner.Parent = ShowButton
ShowButton.Parent = ScreenGui
ShowButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = true
    ShowButton.Visible = false
end)

-- Close GUI button (circle)
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0,30,0,30)
CloseButton.Position = UDim2.new(1,-35,0,5)
CloseButton.Text = "X"
CloseButton.BackgroundColor3 = Color3.fromRGB(200,200,200)
CloseButton.TextColor3 = Color3.new(0,0,0)
CloseButton.Parent = MainFrame
local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0,15)
closeCorner.Parent = CloseButton
CloseButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = false
    ShowButton.Visible = true
end)

-- Toggle Button Helper
local function CreateToggle(name, default, position)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0,200,0,30)
    button.Position = position
    button.Text = name
    button.BackgroundColor3 = default and Color3.fromRGB(0,200,0) or Color3.fromRGB(200,0,0)
    button.TextColor3 = Color3.new(1,1,1)
    button.Parent = MainFrame
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0,6)
    corner.Parent = button
    local state = default
    button.MouseButton1Click:Connect(function()
        state = not state
        button.BackgroundColor3 = state and Color3.fromRGB(0,200,0) or Color3.fromRGB(200,0,0)
        ValoxESP.Settings.ESPEnabled = state
    end)
end

CreateToggle("ESP", true, UDim2.new(0,20,0,40))

-- Kill All Button
local KillAllButton = Instance.new("TextButton")
KillAllButton.Size = UDim2.new(0,200,0,30)
KillAllButton.Position = UDim2.new(0,20,0,80)
KillAllButton.Text = "Kill All (3s)"
KillAllButton.BackgroundColor3 = Color3.fromRGB(255,0,0)
KillAllButton.TextColor3 = Color3.new(1,1,1)
KillAllButton.Parent = MainFrame
local killCorner = Instance.new("UICorner")
killCorner.CornerRadius = UDim.new(0,6)
killCorner.Parent = KillAllButton

-- Gun Beam Button
local GunBeamButton = Instance.new("TextButton")
GunBeamButton.Size = UDim2.new(0,200,0,30)
GunBeamButton.Position = UDim2.new(0,20,0,120)
GunBeamButton.Text = "Gun Beam"
GunBeamButton.BackgroundColor3 = Color3.fromRGB(0,0,255)
GunBeamButton.TextColor3 = Color3.new(1,1,1)
GunBeamButton.Parent = MainFrame
local gunCorner = Instance.new("UICorner")
gunCorner.CornerRadius = UDim.new(0,6)
gunCorner.Parent = GunBeamButton

-- Role Detection Functions
local function isMobile()
    local success, result = pcall(function()
        return LocalPlayer.PlayerGui
    end)
    return not success
end

local function getRoleColor(player)
    local char = player.Character
    if char then
        local hasKnife = char:FindFirstChild("Knife") or (player:FindFirstChild("Backpack") and player.Backpack:FindFirstChild("Knife"))
        local hasGun = char:FindFirstChild("Gun") or (player:FindFirstChild("Backpack") and player.Backpack:FindFirstChild("Gun"))
        if hasKnife then return Color3.fromRGB(255,0,0)
        elseif hasGun then return Color3.fromRGB(0,0,255)
        else return Color3.fromRGB(0,255,0)
        end
    end
    return Color3.fromRGB(255,255,255)
end

-- ESP Functions
local function createESP(player)
    if ValoxESP.Boxes[player] then return end
    if not player.Character then return end
    local highlight = Instance.new("Highlight")
    highlight.Name = "ValoxESPHighlight"
    highlight.Adornee = player.Character
    highlight.FillColor = getRoleColor(player)
    highlight.FillTransparency = 0.25
    highlight.OutlineColor = Color3.new(1,1,1)
    highlight.OutlineTransparency = 0
    highlight.Parent = player.Character
    ValoxESP.Boxes[player] = highlight

    local head = player.Character:FindFirstChild("Head")
    if head then
        local nameTag = Instance.new("BillboardGui")
        nameTag.Name = "ValoxESPName"
        nameTag.Adornee = head
        nameTag.Size = UDim2.new(0,100,0,30)
        nameTag.AlwaysOnTop = true
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,1,0)
        label.BackgroundTransparency = 1
        label.Text = player.Name
        label.TextColor3 = getRoleColor(player)
        label.Parent = nameTag
        nameTag.Parent = player.Character
        ValoxESP.Names[player] = label
    end
end

local function removeESP(player)
    if ValoxESP.Boxes[player] then
        ValoxESP.Boxes[player]:Destroy()
        ValoxESP.Boxes[player] = nil
    end
    if ValoxESP.Names[player] then
        ValoxESP.Names[player].Parent:Destroy()
        ValoxESP.Names[player] = nil
    end
end

local function updateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if ValoxESP.Settings.ESPEnabled then
                createESP(player)
                if ValoxESP.Boxes[player] then
                    ValoxESP.Boxes[player].FillColor = getRoleColor(player)
                end
                if ValoxESP.Names[player] then
                    ValoxESP.Names[player].TextColor3 = getRoleColor(player)
                end
            else
                removeESP(player)
            end
        end
    end
end

-- Continuous ESP Update
RunService.RenderStepped:Connect(updateESP)
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        task.wait(0.5)
        updateESP()
    end)
end)
Players.PlayerRemoving:Connect(function(player)
    removeESP(player)
end)

-- Loop Bring Kill All
local function loopBring(duration, offset)
    local startTime = tick()
    local conn
    conn = RunService.Heartbeat:Connect(function()
        if tick() - startTime > duration then
            if conn then conn:Disconnect() end
            return
        end
        local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            local targetCFrame = root.CFrame * CFrame.new(0,0,-offset)
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local hrp = player.Character.HumanoidRootPart
                    hrp.CFrame = targetCFrame
                    for _, part in pairs(player.Character:GetChildren()) do
                        if part:IsA("BasePart") then part.CanCollide = false end
                    end
                end
            end
            -- Stab
            local knife = LocalPlayer.Character:FindFirstChild("Knife")
            if knife and knife:FindFirstChild("Stab") then
                local args = {"Slash"}
                knife.Stab:FireServer(unpack(args))
            end
        end
    end)
end

KillAllButton.MouseButton1Click:Connect(function()
    loopBring(3,1)
end)

-- Gun Beam
GunBeamButton.MouseButton1Click:Connect(function()
    local murderer
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            local hasKnife = p.Character:FindFirstChild("Knife") or (p:FindFirstChild("Backpack") and p.Backpack:FindFirstChild("Knife"))
            if hasKnife then
                murderer = p
                break
            end
        end
    end
    if not murderer then return end
    local torso = murderer.Character and murderer.Character:FindFirstChild("HumanoidRootPart")
    if torso then
        local gun = LocalPlayer.Character:FindFirstChild("Gun")
        if gun and gun:FindFirstChild("KnifeLocal") and gun.KnifeLocal:FindFirstChild("CreateBeam") and gun.KnifeLocal.CreateBeam:FindFirstChild("RemoteFunction") then
            gun.KnifeLocal.CreateBeam.RemoteFunction:InvokeServer(1, torso.Position, "AH2")
        end
    end
end)